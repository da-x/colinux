Keyboard driver


Index: linux-2.6.22-source/drivers/input/keyboard/Kconfig
===================================================================
--- linux-2.6.22-source.orig/drivers/input/keyboard/Kconfig
+++ linux-2.6.22-source/drivers/input/keyboard/Kconfig
@@ -17,7 +17,7 @@
 	default y
 	select SERIO
 	select SERIO_LIBPS2
-	select SERIO_I8042 if X86_PC
+	select SERIO_I8042 if X86_PC && !COOPERATIVE
 	select SERIO_GSCPS2 if GSC
 	help
 	  Say Y here if you want to use a standard AT or PS/2 keyboard. Usually
Index: linux-2.6.22-source/drivers/input/keyboard/atkbd.c
===================================================================
--- linux-2.6.22-source.orig/drivers/input/keyboard/atkbd.c
+++ linux-2.6.22-source/drivers/input/keyboard/atkbd.c
@@ -28,6 +28,7 @@
 #include <linux/workqueue.h>
 #include <linux/libps2.h>
 #include <linux/mutex.h>
+#include <linux/cooperative_internal.h>
 
 #define DRIVER_DESC	"AT and PS/2 keyboard driver"
 
@@ -659,6 +660,9 @@
 	struct ps2dev *ps2dev = &atkbd->ps2dev;
 	unsigned char param[2];
 
+	if (cooperative_mode_enabled())
+		return 0;
+
 /*
  * Some systems, where the bit-twiddling when testing the io-lines of the
  * controller may confuse the keyboard need a full reset of the keyboard. On
Index: linux-2.6.22-source/drivers/input/serio/Kconfig
===================================================================
--- linux-2.6.22-source.orig/drivers/input/serio/Kconfig
+++ linux-2.6.22-source/drivers/input/serio/Kconfig
@@ -21,7 +21,7 @@
 config SERIO_I8042
 	tristate "i8042 PC Keyboard controller" if EMBEDDED || !X86
 	default y
-	depends on !PARISC && (!ARM || ARCH_SHARK || FOOTBRIDGE_HOST) && !M68K
+	depends on !PARISC && (!ARM || ARCH_SHARK || FOOTBRIDGE_HOST) && !M68K && !COOPERATIVE
 	---help---
 	  i8042 is the chip over which the standard AT keyboard and PS/2
 	  mouse are connected to the computer. If you use these devices,
@@ -158,6 +158,7 @@
 
 config SERIO_LIBPS2
 	tristate "PS/2 driver library" if EMBEDDED
+	depends on !COOPERATIVE
 	help
 	  Say Y here if you are using a driver for device connected
 	  to a PS/2 port, such as PS/2 mouse or standard AT keyboard.
@@ -180,4 +181,9 @@
 	  To compile this driver as a module, choose M here: the
 	  module will be called serio_raw.
 
+config SERIO_COKBD
+ 	tristate "Cooperative Linux virtual keyboard controller driver"
+ 	depends on COOPERATIVE
+ 	default y
+
 endif
Index: linux-2.6.22-source/drivers/input/serio/Makefile
===================================================================
--- linux-2.6.22-source.orig/drivers/input/serio/Makefile
+++ linux-2.6.22-source/drivers/input/serio/Makefile
@@ -20,3 +20,4 @@
 obj-$(CONFIG_SERIO_MACEPS2)	+= maceps2.o
 obj-$(CONFIG_SERIO_LIBPS2)	+= libps2.o
 obj-$(CONFIG_SERIO_RAW)		+= serio_raw.o
+obj-$(CONFIG_SERIO_COKBD)	+= cokbd.o
Index: linux-2.6.22-source/drivers/input/serio/cokbd.c
===================================================================
--- linux-2.6.22-source.orig/drivers/input/serio/cokbd.c
+++ linux-2.6.22-source/drivers/input/serio/cokbd.c
@@ -11,7 +11,6 @@
  * the Free Software Foundation.
  */
 
-#include <linux/config.h>
 #include <linux/delay.h>
 #include <linux/module.h>
 #include <linux/interrupt.h>
@@ -35,7 +34,7 @@
 
 static struct serio cokbd_port;
 
-static irqreturn_t cokbdio_interrupt(int irq, void *dev_id, struct pt_regs *regs);
+static irqreturn_t cokbdio_interrupt(int irq, void *dev_id);
 
 /*
  * cokbd_flush() flushes all data that may be in the keyboard buffers
@@ -59,13 +58,6 @@
 
 #define ATKBD_CMD_GETID		0x02f2
 
-static void cokbd_receive(struct serio *port, unsigned char c)
-{
-	struct pt_regs regs= {0, };
-
-	serio_interrupt(port, c, 0, &regs);
-}
-
 static int cokbd_write(struct serio *port, unsigned char c)
 {
 	return 0;
@@ -118,7 +110,7 @@
  * to the upper layers.
  */
 
-static irqreturn_t cokbdio_interrupt(int irq, void *dev_id, struct pt_regs *regs)
+static irqreturn_t cokbdio_interrupt(int irq, void *dev_id)
 {
 	co_message_node_t *node_message;
 	while (co_get_message(&node_message, CO_DEVICE_KEYBOARD)) {
@@ -129,7 +121,7 @@
 		if (!sc->down)
 			scancode |= 0x80;
 
-		cokbd_receive(&cokbd_port, scancode);
+		serio_interrupt(&cokbd_port, scancode, 0);
 
 		co_free_message(node_message);
 	}
